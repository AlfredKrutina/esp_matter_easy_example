# Matter Light ESP32-C6 - FinÃ¡lnÃ­ PrÅ¯vodce a Troubleshooting

## ğŸ” DÅ®LEÅ½ITÃ‰ BODY PRO FUNKÄŒNOST

### 1. PÅ˜ESNÃ‰ KNIHOVNY KTERÃ‰ BUDETE POTÅ˜EBOVAT

**PovinnÃ© komponenty:**
- [x] `led_strip` (verze 2.5.4+) - pro WS2812B na GPIO8 via RMT
- [x] `esp-matter` (verze 1.4.0+) - Matter protokol
- [x] `nvs_flash` (souÄÃ¡st esp-idf) - uklÃ¡dÃ¡nÃ­ Matter factory data
- [x] `esp_wifi` (souÄÃ¡st esp-idf) - WiFi 2.4GHz
- [x] `led_strip/hal/gpio.h` - pro GPIO8 manipulaci

**Automaticky vÄÃ­tÃ¡ny:**
- `cbor` - serialization Matter
- `esp_common` - common utilities
- `esp_netif` - network interface
- `esp_event` - event loop
- `freertos` - real-time kernel
- `mbedtls` - encryption pro Matter

---

## ğŸ“¥ SEZNAM PÅ˜ÃKAZÅ® - COPY-PASTE

### Ãškol 1: Instalace ESP-IDF (jednou)

```bash
mkdir -p ~/esp
cd ~/esp
git clone --recursive https://github.com/espressif/esp-idf.git
cd esp-idf
git checkout v5.2.2
./install.sh
```

### Ãškol 2: Instalace ESP-Matter (jednou)

```bash
cd ~/esp
git clone --depth 1 https://github.com/espressif/esp-matter.git
cd esp-matter
git submodule update --init --depth 1
cd ./connectedhomeip/connectedhomeip
./scripts/checkout_submodules.py --platform esp32 linux --shallow
cd ../..
./install.sh
```

### Ãškol 3: NastavenÃ­ projektu (pokaÅ¾dÃ© v novÃ©m terminÃ¡lu)

```bash
# V novÃ©m terminÃ¡lu:
cd ~/esp/esp-idf && source ./export.sh
cd ~/esp/esp-matter && source ./export.sh

# Pak v projektu:
cd ~/projects/matter-light-esp32c6
idf.py set-target esp32c6
idf.py menuconfig
# â†’ Example Configuration â†’ WIFI_SSID â†’ "YOUR_SSID"
# â†’ Example Configuration â†’ WIFI_PASSWORD â†’ "YOUR_PASSWORD"
# â†’ Save â†’ Exit
```

### Ãškol 4: Build a Flash

```bash
# V adresÃ¡Å™i projektu:
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor
```

---

## âš¡ FAILSAFE VERIFICACE

KdyÅ¾ budete stavÄ›t, mÄ›li byste vidÄ›t v logu:

âœ“ **SprÃ¡vnÄ›:**
```
...
Linking CXX executable main.elf
...
[100%] Built target main.elf
...
esptool.py esp 32 -p /dev/ttyUSB0 -b 460800 write_flash ...
```

âœ— **Chyba - Led strip nenalezen:**
```
main.c:x:x: fatal error: led_strip.h: No such file or directory
Å˜eÅ¡enÃ­: idf.py add-dependency "espressif/led_strip"
```

âœ— **Chyba - Matter nenalezen:**
```
fatal error: esp_matter.h: No such file or directory
Å˜eÅ¡enÃ­: Ujistit se, Å¾e pouÅ¾Ã­vÃ¡te esp-matter z ~/esp, ne managed component
```

âœ— **Chyba - RMT nenalezen:**
```
undefined reference to `led_strip_new_rmt_device'
Å˜eÅ¡enÃ­: OvÄ›Å™it, Å¾e led_strip je v REQUIRES v main/CMakeLists.txt
```

---

## ğŸ”§ TESTOVÃNÃ FUNKCÃ POSTUPNÄš

### Test 1: LED inicializace (bez Matter)

VytvoÅ™it `test_led.c` v `main/`:
```c
#include "esp_log.h"
#include "led_driver.h"

void app_main(void) {
    ESP_LOGI("TEST", "LED test started");
    led_driver_init();
    led_driver_set_color(255, 0, 0);  // ÄŒervenÃ¡
    vTaskDelay(1000 / portTICK_PERIOD_MS);
    led_driver_set_onoff(false);
    ESP_LOGI("TEST", "LED test complete");
}
```

### Test 2: WiFi pÅ™ipojenÃ­ (bez Matter)

PÅ™idat do `app_main()`:
```c
app_wifi_init();
// MÄ›lo by vypsat: "WiFi inicializovÃ¡no" a "ObdrÅ¾ena IP: ..."
```

### Test 3: Matter Node (kompletnÃ­ test)

KdyÅ¾ mÃ¡te oba testy OK, spusÅ¥te kompletnÃ­ `app_main()`.

---

## ğŸ¯ POKUD CHCETE JEN FUNKÄŒNOST

MinimÃ¡lnÃ­ potÅ™ebnÃ© soubory:

1. **main.c** - z mÃ©ho poskytnutÃ©ho kÃ³du
2. **components/led_driver/** - kompletnÃ­
3. **components/matter_config/matter_config.h** - upravenÃ½ SSID/heslo
4. **CMakeLists.txt** - z mÃ©ho poskytnutÃ©ho
5. **sdkconfig.defaults** - z mÃ©ho poskytnutÃ©ho

StaÄÃ­ zkopÃ­rovat tyto 5 vÄ›cÃ­, a pak:

```bash
idf.py set-target esp32c6
idf.py menuconfig  # ZmÄ›nit SSID/heslo
idf.py build
```

---

## ğŸ“Š VERZE KOMPATIBILITY

| Komponenta | Verze | Kompatibilita |
|-----------|-------|---------------|
| ESP-IDF | 5.2.2 - 5.3.x | âœ“ TestovÃ¡no |
| ESP-Matter | 1.4.0+ | âœ“ TestovÃ¡no |
| led_strip | 2.5.4+ | âœ“ TestovÃ¡no |
| ESP32-C6 | DevKit-C | âœ“ TestovÃ¡no |

---

## ğŸš¨ KRITICKÃ‰ VÄšCI, KTERÃ‰ SELHAJÃ PROJEKTU

### âŒ Chyba 1: ChybnÃ¡ WiFi frekvence
```
SYMPTOM: Device se pÅ™idÃ¡ do Home, ale "No Response"
PÅ˜ÃÄŒINA: WiFi router na 5GHz
Å˜EÅ ENÃ: ZmÄ›nit router na 2.4GHz ONLY
```

### âŒ Chyba 2: StarÃ© iOS
```
SYMPTOM: "Unable to Add Accessory" s kÃ³dem
PÅ˜ÃÄŒINA: iOS < 16.5
Å˜EÅ ENÃ: Upgradovat na iOS 16.5+
```

### âŒ Chyba 3: Å patnÃ© GPIO
```
SYMPTOM: Build OK, LED nereaguje
PÅ˜ÃÄŒINA: LED na jinÃ©m GPIO
Å˜EÅ ENÃ: OvÄ›Å™it GPIO8 v led_driver.h
#define LED_GPIO_NUM 8  // â† Toto
```

### âŒ Chyba 4: Å patnÃ½ LED formÃ¡t
```
SYMPTOM: NesmyslnÃ© barvy
PÅ˜ÃÄŒINA: RGB vs GRB format
Å˜EÅ ENÃ: V led_driver.c:
.led_pixel_format = LED_PIXEL_FORMAT_GRB,  // â† GRB, ne RGB!
```

### âŒ Chyba 5: ChybÄ›jÃ­cÃ­ NVS
```
SYMPTOM: Matter crashuje po restart
PÅ˜ÃÄŒINA: NVS nevyÄiÅ¡tÄ›n
Å˜EÅ ENÃ: idf.py erase_flash
```

---

## ğŸ“ REFERENCE PÅ˜ÃKAZÅ® PRO COMMISSIONING

KdyÅ¾ je device buildovÃ¡n a flushnutÃ½, v Apple Home:

1. OtevÅ™Ã­t Home app
2. Kliknout "+" â†’ "Add Accessory"
3. Naskenovat QR code z sÃ©riovÃ©ho vÃ½stupu
4. Vybrat WiFi sÃ­Å¥ (MUSÃ BÃT 2.4GHz!)
5. Zadat heslo WiFi
6. Vybrat Room a dÃ¡t finish

---

## ğŸ” SECURITY NOTES (Pro production)

- [ ] ZmÄ›nit MATTER_PIN_CODE v matter_config.h
- [ ] ZmÄ›nit MATTER_DISCRIMINATOR
- [ ] Generovat vlastnÃ­ Matter certificates (pro devkit OK)
- [ ] Nastavit power saving: `esp_wifi_set_ps(WIFI_PS_MODEM);`

---

## ğŸ“ DEBUGGING COMMANDS

```bash
# 1. OvÄ›Å™it sÃ©riovÃ½ vÃ½stup s DEBUG loggingem
idf.py -p /dev/ttyUSB0 monitor -l DEBUG

# 2. Viz aktuÃ¡lnÃ­ Matter stav
matter esp diagnostics mem-dump

# 3. PÅ™ipojit WiFi z CLI
matter esp wifi connect YOUR_SSID YOUR_PASSWORD

# 4. Reset k factory stavu
matter device factoryreset

# 5. VidÄ›t commissioning kÃ³d
matter onboardingcodes
```

---

## âœ… CHECKLIST PÅ˜ED FLASH

- [ ] ESP-IDF v5.2.2+ nainstalovÃ¡n
- [ ] ESP-Matter nainstalovÃ¡n
- [ ] `idf.py set-target esp32c6` proveden
- [ ] `sdkconfig.defaults` mÃ¡ YOUR_SSID a YOUR_PASSWORD
- [ ] `main/CMakeLists.txt` mÃ¡ `esp-matter` v REQUIRES
- [ ] `components/led_driver/CMakeLists.txt` existuje
- [ ] `led_driver.h` a `led_driver.c` existujÃ­
- [ ] Projekt builduje: `idf.py build` - bez chyb
- [ ] ESP32-C6 je USB pÅ™ipojena: `ls /dev/ttyUSB0`
- [ ] VÃ¡Å¡ router je na 2.4GHz
- [ ] iOS zaÅ™Ã­zenÃ­ je v sÃ­tÃ­ sÃ­tÄ›

---

## ğŸ“ EDUCATIONAL RESOURCES

Pro hlubÅ¡Ã­ pochopenÃ­:
- Matter spec: https://csa-iot.org/matter-specification/
- ESP-IDF docs: https://docs.espressif.com/projects/esp-idf/
- ESP-Matter guide: https://docs.espressif.com/projects/esp-matter/
- Matter clustering: https://github.com/project-chip/connectedhomeip

---

## âœ¨ FINÃLNÃ TIP

KdyÅ¾ vÅ¡echno selÅ¾e:

1. **Smazat build**
   ```bash
   rm -rf build/ managed_components/ .idf_py_cache/ sdkconfig
   ```

2. **PÅ™einstalovat environment**
   ```bash
   cd ~/esp/esp-idf && source ./export.sh
   cd ~/esp/esp-matter && source ./export.sh
   ```

3. **NovÃ½ build od nuly**
   ```bash
   idf.py set-target esp32c6
   idf.py menuconfig  # Nastavit SSID/heslo
   idf.py build
   ```

4. **Erase flash na ESP32**
   ```bash
   idf.py erase_flash
   ```

5. **Flash a monitor**
   ```bash
   idf.py -p /dev/ttyUSB0 flash monitor -l DEBUG
   ```

Pokud stÃ¡le vidÃ­te chyby s "led_strip" nebo "esp_matter", znamenÃ¡ to, Å¾e managed components se nestÃ¡hly.
PÅ™idejte je ruÄnÄ›:

```bash
idf.py add-dependency "espressif/led_strip"
idf.py add-dependency "espressif/esp_matter"
idf.py reconfigure
idf.py build
```

---

**HlavnÃ­ vÄ›c: FUNKÄŒNOST ZÃVISÃ NA SPRÃVNÃCH KNIHOVNÃCH A WIFI 2.4GHz!**

Jakmile vidÃ­te v logu:
```
I (xxx) LED_DRIVER: LED driver inicializovÃ¡n
I (xxx) APP: Matter node vytvoÅ™en
I (xxx) WIFI: WiFi inicializovÃ¡no
```

VÅ¡echno funguje âœ“
